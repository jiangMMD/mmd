<title>APP首页分类设置</title>
<!--列表样式信息-->
<link rel="stylesheet" href="assets/css/ui.jqgrid.css"/>
<link rel="stylesheet" href="assets/css/chosen.css"/>
<link rel="stylesheet" href="assets/css/select2.css"/>
<link rel="stylesheet" href="assets/css/colorbox.css"/>


<div class="row">
    <!-- <div class="col-xs-12">
         <div class="space-6"></div>
         <div class="well">
             <form id="queryForm" class="form-horizontal">
                 <div class="form-group">
                     <div class="col-xs-3">
                         <label for="data_name" class="col-sm-3 control-label no-padding-right">分类名:</label>
                         <div class="col-sm-9">
                             <input type="text" id="data_name" name="data_name" class="form-control"/>
                         </div>
                     </div>

                     <div class="col-xs-3">
                         <button class="btn btn-primary" type="button" onclick="queryData()">
                             <i class="ace-icon fa fa-search bigger"></i>
                             查询
                         </button>
                         <button class="btn" type="reset" onclick="resetForm()">
                             <i class="ace-icon fa fa-refresh bigger"></i>
                             重置
                         </button>
                     </div>
                 </div>
             </form>
         </div>
         <div class="space-12"></div>
         <div class="fc-button-group" style="margin-left: 5px;">
             <a id="add" data-rel="tooltip" title="" data-original-title="新增" href="javascript:void(0)" style="padding: 2px;"><i class="ace-icon fa fa-plus-circle purple bigger-125"></i></a>
             <a id="edit" data-rel="tooltip" title="" data-original-title="修改" href="javascript:void(0)" style="padding: 2px;"><i class="ace-icon fa fa-pencil blue bigger-125"></i></a>
             <a id="del" data-rel="tooltip" title="" data-original-title="删除" href="javascript:void(0)" style="padding: 2px;"><i class="ace-icon fa fa-trash-o red bigger-125"></i></a>
         </div>
         <table id="grid-table" ></table>
         <div id="grid-pager"></div>
     </div>--><!-- /.col -->

    <!-- 左边-->

    <div class="col-sm-2">
        <div class="widget-box widget-color-blue2">
            <div class="widget-header">
                <h4 class="widget-title lighter smaller">APP基本设置</h4>
            </div>
            <div class="widget-body" style="min-height: 800px;">
                <div class="widget-main padding-8">
                    <ul id="tree1"></ul>
                </div>
            </div>
        </div>
    </div>

    <!--右边-->
    <!---------------------------------------------------------------------------------------------------------------------------------->
    <!-- 积分-->
    <div class="col-sm-10 right_content" id="jifen">
        <div class="widget-box widget-color-blue2">
            <div class="widget-header">
                <h4 class="widget-title lighter smaller">积分设置</h4>
            </div>
            <form id="jifenForm">
                <div class="widget-body" style="min-height: 720px;">
                    <div class="widget-main padding-8 " style="margin-top: 80px">
                        <!--<h1 id="p1" style="display:none">111</h1>-->
                        <div class="col-xs-4">
                            <label class="col-sm-4 control-label no-padding-right">注册送积分:</label>
                            <input type="hidden" id="id1" name="id1" value="1">
                            <div class="col-sm-5">
                                <input type="number" id="value1" name="value1" class="col-sm-8"/>
                            </div>
                        </div>
                        <label>
                            <input id="state1" value="1" name="state1" class="ace ace-switch ace-switch-5"
                                   type="checkbox">
                            <span class="lbl"> &nbsp&nbsp&nbsp上架/下架</span>
                        </label>
                    </div>
                    <div class="widget-main padding-8">
                        <!--<h1 id="p1" style="display:none">111</h1>-->
                        <div class="col-xs-4">
                            <label class="col-sm-4 control-label no-padding-right">购买产品送积分:</label>
                            <input type="hidden" id="id2" name="id2" value="2">
                            <div class="col-sm-5">
                                <input type="number" id="value2" name="value2" class="col-sm-8"/><span id="backformid"
                                                                                                       class="blue"
                                                                                                       style="font-weight: bold; font-size: 20px">&nbsp;&nbsp;%</span>
                            </div>
                        </div>
                        <label>
                            <input type="radio" name="backform2" class="backform" value="1">
                            <span class="lbl"><font style="vertical-align: inherit;"><font
                                    style="vertical-align: inherit;"> 固定积分</font></font></span>
                        </label>
                        <label>
                            <input type="radio" class="backform" name="backform2" value="2" checked>
                            <span class="lbl"><font style="vertical-align: inherit;"><font
                                    style="vertical-align: inherit;"> 按比例给积分</font></font></span>
                        </label>
                        <label>
                            <input id="state2" value="1" name="state2" class="ace ace-switch ace-switch-5"
                                   type="checkbox">
                            <span class="lbl">&nbsp&nbsp&nbsp上架/下架</span>
                        </label>
                        <button class="btn btn-info" type="button" id="bootbox-confirm1" style="margin:560px 50% 10px">
                            确定并发布
                        </button>
                    </div>

                </div>
            </form>
        </div>
    </div>

    <!------------------------------------------------------------------------------------------------------------------------------------>
    <!--分类-->
    <div class="col-sm-10 right_content" id="fenlei" style="display:none">
        <div class="widget-box widget-color-blue2">
            <div class="widget-header">
                <h4 class="widget-title lighter smaller">分类设置</h4>
            </div>
            <div class="set-content-area">
                <div class="widget-body" style="min-height: 800px;">
                    <div class="col-sm-6">
                        <div class="dd">
                            <ol class="dd-list dd-nodrag" id="fenleilist">
                            </ol>
                        </div>
                        <button class="btn" id="bootbox-regular">添加</button>
                    </div>
                    <button class="btn btn-info" id="bootbox-confirm" style="margin-top: 730px">确定并发布</button>
                </div>
            </div>

        </div>
    </div>

    <!------------------------------------------------------------------------------------------------------------------------------------>
    <!--热门搜索-->
    <div class="col-sm-10 right_content" id="resou" style="display:none">
        <div class="widget-box widget-color-blue2">
            <div class="widget-header">
                <h4 class="widget-title lighter smaller">热门搜索</h4>
            </div>
            <div class="set-content-area">
                <div class="widget-body" style="min-height: 800px;">
                    <div class="col-sm-12" style="margin-top: 20px; height: 200px">
                        <div class="checkbox" id="resoulist">

                        </div>
                    </div>
                    <div class="col-sm-12" style="margin-top: 20px; height: 300px">
                        <div class="widget-header">
                            <h4 class="widget-title lighter smaller">常查询的词汇(按照查询次数从多到少排列)</h4>
                        </div>
                        <button class="btn" id="bootbox-regular2">添加</button>
                        <div class="checkbox" id="changyonglist">

                        </div>

                    </div>

                    <button class="btn btn-info" style="margin: 200px 50% 10px" id="searchBtn">确定并发布</button>
                </div>
            </div>


        </div>
    </div>
    <!------------------------------------------------------------------------------------------------------------------------------------>
    <!--轮播图-->
    <div class="col-sm-10 right_content" id="lunbotu" style="display:none">
        <div class="widget-box widget-color-blue2">
            <div class="widget-header">
                <h4 class="widget-title lighter smaller">轮播图</h4>
            </div>
            <form id="lunbotuForm">
                <div class="widget-body" style="min-height: 800px;">
                    <div class="col-xs-12   ">
                        <div class="space-6"></div>
                        <div class="form-group">
                            <div class="col-sm-12">
                                <div class="widget-box">
                                    <div class="widget-header">
                                        <h4 class="widget-title">轮播图</h4>
                                    </div>
                                    <div class="widget-body">
                                        <div class="widget-main" style="min-height: 300px">
                                            <div class="form-group" id="carouselContent">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-info" id="lunbotuBtn" style="margin:380px 50% 10px">确定并发布</button>
                </div>
            </form>

        </div>
    </div>
    <!------------------------------------------------------------------------------------------------------------------------------------>
    <!--兑换比例-->
    <div class="col-sm-10 right_content" id="duihuan" style="display:none">
        <div class="widget-box widget-color-blue2">
            <div class="widget-header">
                <h4 class="widget-title lighter smaller">兑换比例</h4>
            </div>
            <form id="exchangeForm">
                <div class="widget-body" style="min-height: 720px;">
                    <div class="widget-main padding-8 " style="margin-top: 80px">
                        <!--<h1 id="p1" style="display:none">111</h1>-->
                        <div class="col-xs-4">
                            <label class="col-sm-3 control-label no-padding-right"
                                   style="font-weight: bold; font-size: 20px;">1MMD=</label>
                            <input type="hidden" id="id3" name="id3" value="1">
                            <div class="col-sm-6">
                                <input type="number" id="rate1" name="rate1" class="col-sm-8"  onkeyup="clearNoNum(this)"/><span class="blue"
                                                                                                     style="font-weight: bold; font-size: 20px">&nbsp;&nbsp;RMB</span>
                            </div>
                        </div>
                        <div class="col-xs-4">
                            <label class="col-sm-4 control-label no-padding-right"
                                   style="font-weight: bold; font-size: 20px">一元人民币=</label>
                            <input type="hidden" id="id4" name="id4" value="2">
                            <div class="col-sm-6">
                                <input type="number" id="rate2" name="rate2" class="col-sm-8"/><span class="blue"
                                                                                                     style="font-weight: bold; font-size: 20px">积分</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-info" type="button" id="bootbox-confirm2" style="margin:600px 50% 10px">
                        确定并发布
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<script type="text/javascript">
    var scripts = [null, "assets/js/date-time/bootstrap-datepicker.js",
        // "../assets/js/jqGrid/jquery.jqGrid.js",
        "assets/js/jqGrid/jquery.jqGrid.custom.js",
        "assets/js/chosen.jquery.js",
        "assets/js/fuelux/fuelux.tree.js",
        "assets/js/jqGrid/i18n/grid.locale-cn.js",
        "assets/js/bootbox.js",
        "assets/js/jquery.colorbox.js",
        "assets/js/jquery.nestable.js",
        "assets/js/jquery.form.js",
        "assets/js/select2.js", null]

    var grid_selector = "#grid-table";
    var pager_selector = "#grid-pager";

    //查询表单数据
    function queryData() {
        var formData = $("#queryForm").serializeJson();
        jQuery(grid_selector).jqGrid("setGridParam", {postData: formData}).trigger("reloadGrid", [{page: 1}]);
    }

    //重置
    function resetForm() {
        $(".chosen-select").val('').trigger("chosen:updated");
    }

    var classData = [];


    //删除分类
    function delFenlei(id, name) {
        bootbox.confirm("确认删除该分类？删除之后，保存并发布，该分类信息将无法找回", function (result) {
            if (result) {
                $("li[data-name=" + name + "]").remove();
                var newClassDate = [];
                $("#fenleilist").find(".dd-item").each(function (i) {
                    var id = $(this).attr("data-id");
                    var name = $(this).find(".dd-name").text();
                    newClassDate.push({id: id, name: name, order: i});
                });
                classData = newClassDate;
            }
        });
        console.log(classData);
    }

    //修改分类
    function editFenlei(id, name) {
        bootbox.prompt({
            title: "请输入分类信息",
            value: name,
            callback: function (newname) {
                if (newname) {
                    var tempClassData = [];
                    if (id) {
                        classData.forEach(function (data, i) {
                            if (data.id == id) {
                                data.name = newname;
                            }
                            tempClassData.push(data);
                        })
                    } else {
                        classData.forEach(function (data, i) {
                            if (data.name == name) {
                                data.name = newname;
                            }
                            tempClassData.push(data);
                        })
                    }
                    $("li[data-name=" + name + "]").attr("attr-name", newname);
                    $("li[data-name=" + name + "]").find(".dd-name").text(newname);
                    classData = tempClassData;
                }
            }
        });
        console.log(classData);
    }


    //轮播图中图片下关于产品名称的方法
    function changeProd($this) {
        bootbox.dialog({
            title: '请选择相对应的产品名称',
            message: "<div class=\"row\">" +
                "                        <label class=\"col-sm-2 control-label no-padding-right\">产品名称:</label>" +
                "                        <div class=\"col-sm-10\">" +
                "                            <select id=\"prod_name\" name=\"prod_name\" class=\"form-control\"></select>" +
                "                        </div>" +
                "                    </div>",
            buttons: {
                ok: {
                    label: "OK",
                    className: 'btn-info',
                    callback: function () {
                        $($this).attr("data-id", $("select[name=prod_name]").val());
                        $($this).html("产品：" + $("select[name=prod_name]").text());
                    }
                }
            }
        });

        $("#prod_name").select2({
            ajax: {
                url: projectUrl + '/app/getProdByKey',
                delay: 250,
                cache: true,
                data: function (params) {
                    console.log(params);
                    var query = {
                        key: params.term
                    };
                    return query;
                },
                processResults: function (data, params) {
                    return {
                        results: data.data
                    }
                }
            },
            placeholder: '输入产品名称',
            width: '90%'
        });

    }

    //轮播图删除
    function delCarousel($this, id, orderby) {
        $($this).parent().parent().hide();
        $($this).parent().parent().parent().find("div").first().show();
    }


    $('.page-content-area').ace_ajax('loadScripts', scripts, function () {
        //inline scripts related to this page
        jQuery(function ($) {
            $.fn.modal.Constructor.prototype.enforceFocus = function () {};

            //设置页面左侧的树状图方法
            var sampleData = initiateDemoData();//see below

            $('#tree1').ace_tree({
                dataSource: sampleData['dataSource1'],
                multiSelect: false,
                cacheItems: true,
                'open-icon': 'ace-icon tree-minus',
                'close-icon': 'ace-icon tree-plus',
                'itemSelect': true,
                'folderSelect': false,
                'selected-icon': 'ace-icon fa fa-check',
                'unselected-icon': 'ace-icon fa fa-check',
                loadingHTML: '<div class="tree-loading"><i class="ace-icon fa fa-refresh fa-spin blue"></i></div>'
            });

            function initiateDemoData() {
                var tree_data = {
                    '积分': {id: 'jifen', text: '积分', type: 'item'},
                    '分类': {id: 'fenlei', text: '分类', type: 'item'},
                    '热门搜索': {id: 'resou', text: '热门搜索', type: 'item'},
                    '轮播图': {id: 'lunbotu', text: '轮播图', type: 'item'},
                    'MMD：RMB兑换': {id: 'duihuan', text: 'MMD：RMB兑换', type: 'item'}
                }
                var dataSource1 = function (options, callback) {
                    var $data = null
                    if (!("text" in options) && !("type" in options)) {
                        $data = tree_data;//the root tree
                        callback({data: $data});
                        return;
                    }
                    else if ("type" in options && options.type == "folder") {
                        if ("additionalParameters" in options && "children" in options.additionalParameters)
                            $data = options.additionalParameters.children || {};
                        else $data = {}//no data
                    }
                }
                return {'dataSource1': dataSource1}
            }

            //左侧点击事件
            $("#tree1").find("li").click(function (e) {
                var id = $(this).attr("data-id");
                $(".right_content").hide();
                $("#" + id).show();

                // tree-selected
                $("#tree1").find("li").removeClass("tree-selected");
                $(this).addClass("tree-selected");
                e.stopPropagation();


                //加载分类数据
                if (id === 'fenlei') {
                    loadFenLeiData();
                }

                //加载热门搜索词和历史记录的数据
                if (id === 'resou') {
                    loadReSouData();
                    loadHistoryData();
                }

            });

            //设置刚开始选中积分
            $("#tree1").find("li[data-id=jifen]").addClass("tree-selected");

            //===========================================================================================================
            //积分总方法
            jifenFun();

            function jifenFun() {

                //按钮
                $(".backform").change(function () {
                    if ($(this).val() === "1") {
                        $("#backformid").hide();
                    } else {
                        $("#backformid").show();
                    }
                })

                //积分中的确定按钮
                $("#bootbox-confirm1").on(ace.click_event, function () {
                    var paramData = $("#jifenForm").serializeJson();
                    bootbox.confirm("发布之后将在App中展示，是否确定？", function (result) {
                        if (result) {
                            myAjax("/app/saveIntegral", paramData, function (result) {
                                if (result.code === 1) {
                                    showSuccInfo("操作成功！");
                                    queryData();
                                } else {
                                    showErrorInfo(result.message);
                                }
                            })
                        }
                    });
                });


                //加载积分数据库，显示数据
                myAjax("/app/loadJifen", null, function (res) {
                    if (res.data && res.data.length > 0) {
                        $("#id1").val(res.data[0].id);
                        $("#value1").val(res.data[0].value);
                        if (res.data[0].state == 1) {
                            $("#state1").attr("checked", true);
                        }

                        $("#id2").val(res.data[1].id);
                        $("#value2").val(res.data[1].value);
                        $("input[name=backform2][value='" + res.data[1].backform + "']").attr("checked", true);
                        if (res.data[1].backform == "1") {
                            $("#backformid").hide();
                        } else {
                            $("#backformid").show();
                        }
                        if (res.data[1].state == 1) {
                            $("#state2").attr("checked", true);
                        }
                    }
                });

            }

            //=============================================================================================================================

            //分类总方法
            fenleiFun();

            function fenleiFun() {
                //添加分类
                $("#bootbox-regular").on(ace.click_event, function () {
                    bootbox.prompt("请添加分类名称", function (name) {
                        if (name === null) {
                            showWarnInfo("请输入分类名称");
                        } else {
                            var html = "";
                            html += '<li class="dd-item" data-order="' + (classData.length + 1) + '" data-id="" data-name="' + name + '">';
                            html += '<div class="dd-handle">';
                            html += '<span class="dd-name">' + name + '</span>';
                            html += '<div class="pull-right action-buttons">';
                            html += '<a class="blue" href="javascript:void(0)">';
                            html += '<i class="ace-icon fa fa-pencil bigger-130" onclick=editFenlei("","' + name + '")></i>';
                            html += '</a>';
                            html += '<a class="red" href="javascript:void(0)">';
                            html += '<i class="ace-icon fa fa-trash-o bigger-130"  onclick=delFenlei("","' + name + '")></i>';
                            html += '</a>';
                            html += '</div>';
                            html += '</div>';
                            html += '</li>';
                            classData.push({id: "", name: name, order: classData.length + 1});
                            $("#fenleilist").append(html);
                        }
                    });
                });

                //分类中的确定按钮
                $("#bootbox-confirm").on(ace.click_event, function () {
                    bootbox.confirm("发布之后将在App中展示，是否确定？", function (result) {
                        if (result) {
                            myAjax("/app/saveClassifyInfo", {data: JSON.stringify(classData)}, function (result) {
                                if (result.code === 1) {
                                    showSuccInfo("操作成功！");
                                    queryData();
                                } else {
                                    showErrorInfo(result.message);
                                }
                            })
                        }
                    });
                });

                //分类排序
                $('.dd').nestable();
                $('.dd-handle a').on('mousedown', function (e) {
                    e.stopPropagation();
                });
                $('.dd').nestable().on('change', function (e) {
                    console.log(e);
                    var newClassDate = [];
                    $("#fenleilist").find(".dd-item").each(function (i) {
                        var id = $(this).attr("data-id");
                        var name = $(this).find(".dd-handle").text();
                        newClassDate.push({id: id, name: name, order: i});
                    });
                    classData = newClassDate;
                });
            }

            //从后台加载分类数据
            function loadFenLeiData() {
                myAjax("/app/getClassifyList", null, function (result) {
                    if (result.code === 1) {
                        classData = result.data;
                        createFenleiHtml(result.data)
                    } else {
                        showErrorInfo(result.message);
                    }
                })
            }

            //在设置页面中创建分类页面的方法
            function createFenleiHtml(resData) {
                var html = "";
                if (resData && resData.length > 0) {
                    resData.forEach(function (data) {
                        html += '<li class="dd-item" data-order="' + data.order + '" data-id="' + data.id + '" data-name="' + data.name + '">';
                        html += '<div class="dd-handle">';
                        html += '<span class="dd-name">' + data.name + '</span>';
                        html += '<div class="pull-right action-buttons">';
                        html += '<a class="blue" href="javascript:void(0)">';
                        html += '<i class="ace-icon fa fa-pencil bigger-130" onclick=editFenlei("' + data.id + '","' + data.name + '")></i>';
                        html += '</a>';
                        html += '<a class="red" href="javascript:void(0)">';
                        html += '<i class="ace-icon fa fa-trash-o bigger-130"  onclick=delFenlei("' + data.id + '","' + data.name + '")></i>';
                        html += '</a>';
                        html += '</div>';
                        html += '</div>';
                        html += '</li>';
                    })
                }
                $("#fenleilist").html(html);
            }

            //==============================================================================================================//
            //热门搜索的总方法
            resouFun();

            function resouFun() {
                //添加常查询的词汇
                $("#bootbox-regular2").on(ace.click_event, function () {
                    bootbox.prompt("请添加词汇名称", function (word) {
                        if (word === null) {
                            showWarnInfo("请输入词汇名称");
                        } else {
                            var html = "";
                            html += '<label>';
                            html += '<input name="form-field-checkbox" type="checkbox" class="searchClass" checked="checked" value="' + word + '"/>';
                            html += '<span class="lbl" style="font-size: 20px">' + word + '</span>';
                            html += '</label>&nbsp&nbsp&nbsp&nbsp';
                            $("#changyonglist").append(html);
                        }
                    });
                });
            }

            //从后台加载热门搜索词的数据
            function loadReSouData() {
                myAjax("/app/getHotwordList", null, function (result) {
                    if (result.code === 1) {
                        createResouHtml(result.data)
                    } else {
                        showErrorInfo(result.message);
                    }
                })
            }

            //在设置页面中创建热搜词汇的方法
            function createResouHtml(creData) {
                var html = "";
                if (creData && creData.length > 0) {
                    creData.forEach(function (data) {
                        html += '<label>';
                        html += '<input name="form-field-checkbox" type="checkbox" class="searchClass" checked="checked" value="' + data.word + '"/>';
                        html += '<span class="lbl" style="font-size: 20px">' + data.word + '</span>';
                        html += '</label>&nbsp&nbsp&nbsp&nbsp';
                    })
                }
                $("#resoulist").html(html);
            }

            //从后台加载搜索的历史记录
            function loadHistoryData() {
                myAjax("/app/getHistoryList", null, function (result) {
                    if (result.code === 1) {
                        createHistoryHtml(result.data)
                    } else {
                        showErrorInfo(result.message);
                    }
                })
            }

            //创建搜索历史词汇的方法
            function createHistoryHtml(hisData) {
                var html = "";
                if (hisData && hisData.length > 0) {
                    hisData.forEach(function (data) {
                        html += '<label>';
                        html += '<input name="form-field-checkbox" type="checkbox" class="searchClass" value="' + data.word + '"/>';
                        html += '<span class="lbl" style="font-size: 20px">' + data.word + '</span>';
                        html += '</label>&nbsp&nbsp&nbsp&nbsp';
                    })
                }
                $("#changyonglist").html(html);
            }

            //热门搜索中的确定按钮方法
            $("#searchBtn").click(function () {
                bootbox.confirm("确认发布选中的所有词汇作为APP内搜索热词？", function (result) {
                    if (result) {
                        var data = [];
                        $(".searchClass:checked").each(function () {
                            data.push($(this).val());
                        });
                        myAjax("/app/saveHotWord", {data: JSON.stringify(data)}, function (result) {
                            if (result.code === 1) {
                                showSuccInfo("操作成功！");
                                loadReSouData();
                            } else {
                                showErrorInfo(result.message);
                            }
                        })
                    }
                });
            });

            //======================================================================================================================
            //轮播图中的确定按钮方法
            $("#lunbotuForm").submit(function (e) {
                var prod_ids = "";
                $(".carousel_prod").each(function(){
                    prod_ids += "," + $(this).attr("data-id");
                });
                e.preventDefault();
                $(this).ajaxSubmit({
                    url: projectUrl + "/app/saveCarousel",
                    type: "post",
                    data: {prod_ids: prod_ids.substr(1)},
                    success: function (result) {
                        bootbox.hideAll();
                        if (result.code === 1) {
                            showInfo("操作成功!");

                        } else {
                            showError("操作失败！错误信息：" + result.message);
                        }
                    },
                    error: function (err) {
                        bootbox.hideAll();
                        showErrorInfo("发布失败，" + err.statusText);
                    }
                });
                return false;
            });


            loadCarousel();
            //加载数据库中的轮播图
            function loadCarousel() {
                myAjax("/app/getCarousal", null, function (result) {
                    if (result.code == 1) {
                        var html = "";
                        result.data.forEach(function (data, i) {
                            var hideInput = false;
                            html += '<div class="col-xs-2">';
                            if (data.imgurl) {
                                hideInput = true;
                            }
                            html += '<div style="display: '+(hideInput?'none':'')+'">';
                            html += '<input multiple="" type="file" class="lunbotu" id="tu1" name="carousalFile'+i+'"/>';
                            html += '</div>';
                            html += '<ul class="ace-thumbnails clearfix" style="display: ' + (hideInput ? '' : 'none') + '">';
                            html += '<li>';
                            html += '<a href="'+data.imgurl+'" data-rel="colorbox">';
                            html += '<img width="150" height="150" alt="150x150" src="'+data.imgurl+'" />';
                            html += '<div class="text">';
                            html += '<div class="inner">点击查看大图</div>';
                            html += '</div>';
                            html += '</a>';
                            html += '<div class="tools tools-bottom" onclick="delCarousel(this)" data-id="'+data.id+'" data-order="'+i+'">';
                            html += '<a href="javascript:void(0);">';
                            html += '<i class="ace-icon fa fa-times red"></i>';
                            html += '</a>';
                            html += '</div>';
                            html += '</li>';
                            html += '</ul>';
                            html += '<label>';
                            if(data.pid) {
                                html += '<a class="chanpin"><span class="carousel_prod" data-id="'+data.pid+'" onclick="changeProd(this)">'+(data.pname?"产品：" +data.pname:"点击选择产品")+'</span></a>';
                            }
                            html += '</label>';
                            html += '</div>';
                        });
                        $("#carouselContent").html(html);
                        bindInputFile();
                    } else {
                        showErrorInfo(result.message)
                    }
                });
            }




            function bindInputFile() {
                    $(".lunbotu").ace_file_input({
                        style: 'well',
                        btn_choose: '上传图片',
                        btn_change: null,
                        no_icon: 'ace-icon fa fa-cloud-upload',
                        whitelist:'gif|png|jpg|jpeg',
                        droppable: true,
                        thumbnail: 'small',
                        preview_error: function (filename, error_code) {
                        }
                    }).on('change', function () {
                    });
            }


            //======================================================================================================================
            //兑换比例的总方法

            //保留两位小数的方法
          /*  clearNoNum();
            function clearNoNum(obj){
                obj.value = obj.value.replace(/[^\d.]/g,""); //清除"数字"和"."以外的字符
                obj.value = obj.value.replace(/^\./g,""); //验证第一个字符是数字而不是.
                obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的.
                obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");//只允许输入一个小数点
                obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3'); //只能输入两个小数
            }*/
            exchangeFun();
            function exchangeFun() {
                //兑换比例中确定按钮的方法
                $("#bootbox-confirm2").on(ace.click_event, function () {
                    var paramData = $("#exchangeForm").serializeJson();
                    bootbox.confirm("发布之后将在App中展示，是否确定？", function (result) {
                        if (result) {
                            myAjax("/app/saveRateInfo", paramData, function (result) {
                                if (result.code === 1) {
                                    showSuccInfo("操作成功！");
                                    queryData();
                                } else {
                                    showErrorInfo(result.message);
                                }
                            })
                        }
                    });
                });
                //加载兑换比例的数据库，显示数据
                myAjax("/app/loadExchange", null, function (res) {
                    if (res.data && res.data.length > 0) {
                        $("#id3").val(res.data[0].id);
                        $("#rate1").val(res.data[0].rate);


                        $("#id4").val(res.data[1].id);
                        $("#rate2").val(res.data[1].rate);

                    }
                });
            }

            $(".set-content-area").on("ajaxloaddone", function () {
                $(".set-content-area").ace_ajax("stopLoading", true);
            });

            var parent_column = $(grid_selector).closest('[class*="col-"]');
            $(window).on('resize.jqGrid', function () {
                $(grid_selector).jqGrid('setGridWidth', parent_column.width());
                $(grid_selector).jqGrid('setGridHeight', $(window).height() - 360);
            });
            //resize on sidebar collapse/expand
            $(document).on('settings.ace.jqGrid', function (ev, event_name, collapsed) {
                if (event_name === 'sidebar_collapsed' || event_name === 'main_container_fixed') {
                    //setTimeout is for webkit only to give time for DOM changes and then redraw!!!
                    setTimeout(function () {
                        $(grid_selector).jqGrid('setGridWidth', parent_column.width());
                    }, 0);
                }
            });
            //重新进入时，销毁原有页面信息
            $(document).one('ajaxloadstart.page', function (e) {
                $.jgrid.gridDestroy(grid_selector);
                $('.ui-jqdialog').remove();
            });


            function queryDetail(id) {
                toCustomUrl("server/app/toClassifyDetail?id=" + id);
            }

            $(window).triggerHandler('resize.jqGrid');//trigger window resize to make the grid get the correct size

            jQuery(function ($) {
                var $overflow = '';
                var colorbox_params = {
                    rel: 'colorbox',
                    reposition: true,
                    scalePhotos: true,
                    scrolling: false,
                    previous: '<i class="ace-icon fa fa-arrow-left"></i>',
                    next: '<i class="ace-icon fa fa-arrow-right"></i>',
                    close: '&times;',
                    current: '{current} of {total}',
                    maxWidth: '100%',
                    maxHeight: '100%',
                    onOpen: function () {
                        $overflow = document.body.style.overflow;
                        document.body.style.overflow = 'hidden';
                    },
                    onClosed: function () {
                        document.body.style.overflow = $overflow;
                    },
                    onComplete: function () {
                        $.colorbox.resize();
                    }
                };

                $('.ace-thumbnails [data-rel="colorbox"]').colorbox(colorbox_params);
                $("#cboxLoadingGraphic").html("<i class='ace-icon fa fa-spinner orange fa-spin'></i>");//let's add a custom loading icon

                $(document).one('ajaxloadstart.page', function (e) {
                    $('#colorbox, #cboxOverlay').remove();
                });
            })
        });
    });

</script>